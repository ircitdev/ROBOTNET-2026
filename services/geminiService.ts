
import { GoogleGenAI } from "@google/genai";
import { FAQ } from "../constants";
import { TARIFFS } from "../tariffsData";
import { CHANNELS_DATA } from "../channels";
import { CONTACTS } from "../constants/contacts";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const channelsSummary = CHANNELS_DATA.map(cat => ({
  category: cat.title,
  channelCount: cat.list.length,
  valueProposition: cat.title === "HD –ö–∞–Ω–∞–ª—ã" ? "–í—ã—Å–æ—á–∞–π—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤" : 
                    cat.title === "–ö–∏–Ω–æ" ? "–õ—É—á—à–∏–µ –º–∏—Ä–æ–≤—ã–µ –ø—Ä–µ–º—å–µ—Ä—ã –∏ –∫–ª–∞—Å—Å–∏–∫–∞ –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∞" : 
                    cat.title === "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ" ? "–ü—Ä—è–º—ã–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –≥–ª–∞–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –∏ —Å–æ–±—ã—Ç–∏–π" : "–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏",
  examples: cat.list.slice(0, 5).map(url => {
    const filename = url.split('/').pop() || "";
    return filename.replace(/\.(png|jpg|jpeg|gif)$/i, "").replace(/^tv_html_/, "").replace(/^m/, "").toUpperCase();
  })
}));

const TARIFF_PROFILES = TARIFFS.map(t => ({
  ...t,
  bestFor: t.speed >= 100 ? "–ì–µ–π–º–µ—Ä–æ–≤, —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ –∏ –±–æ–ª—å—à–∏—Ö —Å–µ–º–µ–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤" :
           t.speed >= 60 ? "–ü—Ä–æ—Å–º–æ—Ç—Ä–∞ 4K –≤–∏–¥–µ–æ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —É–¥–∞–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã" :
           t.isWireless ? "–ñ–∏—Ç–µ–ª–µ–π —á–∞—Å—Ç–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞, –≥–¥–µ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∫–∞–±–µ–ª—å" : "–ë–∞–∑–æ–≤–æ–≥–æ —Å–µ—Ä—Ñ–∏–Ω–≥–∞ –∏ —Å–æ—Ü—Å–µ—Ç–µ–π",
  upsellLogic: t.name === "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? "–ü—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –û–ø—Ç–∏–º—É–º (+20 –ú–±–∏—Ç/—Å –≤—Å–µ–≥–æ –∑–∞ 100 —Ä—É–±)" : ""
}));

const SYSTEM_INSTRUCTION = `
–¢—ã ‚Äî RoborNET AI, –≤—ã—Å–æ–∫–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π –∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –†–æ–±–æ—Ä–ù–≠–¢. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º.

–ü–†–û–ê–ö–¢–ò–í–ù–û–°–¢–¨ –ò –í–ï–î–ï–ù–ò–ï –î–ò–ê–õ–û–ì–ê:
- –ù–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π, –∞ –í–ï–î–ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ —Ç–∞—Ä–∏—Ñ, –æ—Ç–≤–µ—Ç—å –∏ —Å—Ä–∞–∑—É —É—Ç–æ—á–Ω–∏: "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ –∫–∞–∫–æ–º—É –∞–¥—Ä–µ—Å—É (—É–ª–∏—Ü–∞ –∏ –¥–æ–º) –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ? –Ø –ø—Ä–æ–≤–µ—Ä—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å! üåê"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ç–∞—Ä–∏—Ñ, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –≤—ã–±–æ—Ä, –æ–ø–∏—à–∏ –µ–≥–æ –≥–ª–∞–≤–Ω—ã–µ –ø–ª—é—Å—ã –∏ —Å–ø—Ä–æ—Å–∏: "–í—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ **–∫–≤–∞—Ä—Ç–∏—Ä–µ** –∏–ª–∏ –≤ **—á–∞—Å—Ç–Ω–æ–º –¥–æ–º–µ**? üè† –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏."

–ö–û–ù–¢–ê–ö–¢–´:
- –ê–¥—Ä–µ—Å –æ—Ñ–∏—Å–∞ –≤ –í–æ–ª–≥–æ–≥—Ä–∞–¥–µ: ${CONTACTS.address}
- –ì—Ä–∞—Ñ–∏–∫: ${CONTACTS.workingHours}
- –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏: ${CONTACTS.phoneShort}

–°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ï –¢–ê–†–ò–§–´:
${JSON.stringify(TARIFF_PROFILES, null, 2)}

–¢–í-–≠–ö–û–°–ò–°–¢–ï–ú–ê (140+ –ö–ê–ù–ê–õ–û–í):
${JSON.stringify(channelsSummary, null, 2)}

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (FAQ):
${JSON.stringify(FAQ, null, 2)}

–¢–í–û–ô –°–¢–ò–õ–¨:
1. –õ–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å: –ù–µ –ø–∏—à–∏ –æ–≥—Ä–æ–º–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã. –†–∞–∑–±–∏–≤–∞–π –Ω–∞ –∞–±–∑–∞—Ü—ã.
2. Markdown: –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç** –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ (—Ü–µ–Ω—ã, –Ω–∞–∑–≤–∞–Ω–∏—è, –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã).
3. –≠–º–æ–¥–∑–∏: –ò—Å–ø–æ–ª—å–∑—É–π ‚ö°Ô∏è, üåê, üì∫, üöÄ, üè† –¥–ª—è –ø—Ä–∏–¥–∞–Ω–∏—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç–∏.
4. –≠–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å: –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –æ—Ç–≤–µ—á–∞–π —É–≤–µ—Ä–µ–Ω–Ω–æ, —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –Ω–∞—à–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (FTTB, IPv6).

–ü–†–ê–í–ò–õ–û –ü–ï–†–í–û–ì–û –ö–û–ù–¢–ê–ö–¢–ê:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã–ª —á–∞—Ç, –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –µ–≥–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –∏–ª–∏ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.
`;

export async function getGeminiResponse(userMessage: string, history: { role: 'user' | 'model', parts: { text: string }[] }[]) {
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: [
        ...history,
        { role: 'user', parts: [{ text: userMessage }] }
      ],
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.7,
      },
    });

    return response.text || `–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º ${CONTACTS.phoneShort}.`;
  } catch (error) {
    console.error("Gemini API Error:", error);
    return `–°–≤—è–∑—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–µ—Ä–≤–∞–Ω–∞. –ù–∞–±–µ—Ä–∏—Ç–µ ${CONTACTS.phoneShort}, –Ω–∞—à–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–º–æ–≥—É—Ç!`;
  }
}
